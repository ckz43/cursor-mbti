# 配置迁移指南

本文档说明了如何将MBTI测试系统从硬编码配置迁移到基于配置文件的配置管理。

## 迁移概述

### 已完成的迁移

#### 1. 后端配置 (server.js)
- ✅ 创建了统一的配置文件 `config/index.js`
- ✅ 数据库连接配置从环境变量读取
- ✅ 服务器端口、主机配置
- ✅ JWT密钥和过期时间配置
- ✅ CORS跨域配置
- ✅ 请求限流配置
- ✅ 请求体大小限制配置
- ✅ 管理员默认账户配置

#### 2. 前端配置 (src/config/index.ts)
- ✅ 创建了前端配置文件
- ✅ API基础URL配置
- ✅ 应用基本信息配置
- ✅ 功能开关配置
- ✅ 更新了所有管理后台组件的API调用

#### 3. 环境变量配置 (.env.example)
- ✅ 完善了所有配置项的环境变量
- ✅ 添加了详细的配置分类和说明
- ✅ 包含了数据库、安全、限流、邮件、支付等配置

#### 4. MCP配置 (mcp-config.json)
- ✅ 更新为从环境变量读取数据库配置

## 配置文件结构

### 后端配置 (config/index.js)

```javascript
// 服务器配置
export const serverConfig = {
  port: 服务器端口,
  host: 服务器主机,
  env: 运行环境,
  frontendUrl: 前端URL,
  security: {
    jwtSecret: JWT密钥,
    jwtExpiresIn: JWT过期时间,
    bcryptRounds: 密码加密轮数,
    corsOrigin: CORS允许的源
  },
  rateLimit: {
    windowMs: 限流时间窗口,
    max: 最大请求数,
    adminMax: 管理接口最大请求数
  },
  bodyParser: {
    jsonLimit: JSON请求体大小限制,
    urlencodedLimit: URL编码请求体大小限制
  }
}

// 数据库配置
export const dbConfig = {
  host: 数据库主机,
  port: 数据库端口,
  user: 数据库用户,
  password: 数据库密码,
  database: 数据库名,
  pool: {
    connectionLimit: 连接池大小,
    queueLimit: 队列限制,
    acquireTimeout: 获取连接超时,
    timeout: 查询超时,
    reconnect: 自动重连,
    charset: 字符集
  }
}
```

### 前端配置 (src/config/index.ts)

```typescript
// API配置
export const apiConfig = {
  baseUrl: API基础URL,
  timeout: 请求超时时间
}

// 应用配置
export const appConfig = {
  name: 应用名称,
  version: 应用版本,
  debugMode: 调试模式
}

// 功能配置
export const featureConfig = {
  payment: 支付功能开关,
  analytics: 分析功能开关
}
```

## 环境变量配置

### 必需的环境变量

```bash
# 服务器配置
PORT=3001
HOST=localhost
NODE_ENV=development
FRONTEND_URL=http://localhost:5173

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=mbti_test

# 安全配置
JWT_SECRET=your_jwt_secret_key
JWT_EXPIRES_IN=24h
CORS_ORIGIN=http://localhost:5173

# 管理员配置
ADMIN_USERNAME=admin
ADMIN_PASSWORD=password
```

### 可选的环境变量

```bash
# 邮件配置
EMAIL_ENABLED=false
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=your_email@example.com
SMTP_PASS=your_password

# 支付配置
PAYMENT_ENABLED=false
WECHAT_APP_ID=your_wechat_app_id
ALIPAY_APP_ID=your_alipay_app_id

# Redis配置
REDIS_ENABLED=false
REDIS_HOST=localhost
REDIS_PORT=6379

# 前端配置
VITE_API_BASE_URL=/api
VITE_APP_NAME=MBTI性格测试
VITE_DEBUG_MODE=false
```

## 使用方法

### 1. 复制环境变量文件

```bash
cp .env.example .env
```

### 2. 编辑环境变量

根据你的实际环境修改 `.env` 文件中的配置值。

### 3. 在代码中使用配置

#### 后端使用

```javascript
import config from './config/index.js'

// 使用数据库配置
const dbPool = mysql.createPool({
  host: config.db.host,
  port: config.db.port,
  user: config.db.user,
  password: config.db.password,
  database: config.db.database
})

// 使用服务器配置
app.listen(config.server.port, () => {
  console.log(`服务器运行在端口 ${config.server.port}`)
})
```

#### 前端使用

```typescript
import { config } from '../config/index'

// 使用API配置
const API_BASE = config.api.baseUrl

// 发起API请求
fetch(`${API_BASE}/admin/users`)
```

## 配置验证

配置文件包含了验证函数，可以检查配置的有效性：

```javascript
import config from './config/index.js'

// 验证配置
const errors = config.validateConfig()
if (errors.length > 0) {
  console.error('配置错误:', errors)
  process.exit(1)
}
```

## 迁移检查清单

- [x] 后端服务器配置迁移
- [x] 数据库连接配置迁移
- [x] JWT认证配置迁移
- [x] 前端API配置迁移
- [x] 管理后台组件配置迁移
- [x] 环境变量文件完善
- [x] MCP配置文件更新
- [ ] 生产环境部署配置
- [ ] Docker配置文件更新
- [ ] CI/CD配置更新

## 注意事项

1. **安全性**: 生产环境必须使用强密码和自定义JWT密钥
2. **环境隔离**: 不同环境使用不同的配置文件
3. **敏感信息**: 不要将包含敏感信息的 `.env` 文件提交到版本控制
4. **配置验证**: 启动时验证配置的完整性和有效性
5. **向后兼容**: 保留环境变量的默认值以确保向后兼容

## 故障排除

### 常见问题

1. **配置文件找不到**: 确保配置文件路径正确
2. **环境变量未生效**: 检查 `.env` 文件是否在正确位置
3. **数据库连接失败**: 验证数据库配置参数
4. **前端API调用失败**: 检查API基础URL配置

### 调试方法

```javascript
// 打印当前配置
console.log('当前配置:', config)

// 检查环境变量
console.log('环境变量:', process.env)
```

## 后续改进

1. 添加配置热重载功能
2. 实现配置的动态更新
3. 添加配置的Web管理界面
4. 支持多环境配置文件
5. 添加配置的加密存储