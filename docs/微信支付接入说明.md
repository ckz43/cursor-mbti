# 微信支付 v3（JSAPI）正式接入说明

本说明基于本项目现有后端（`server.js`）与配置（`config/index.js`）实现，指导你在生产环境完成微信支付 v3（JSAPI）接入。若使用公众号内网页支付，需要获取 `openid`；若非微信内页，请改造为 H5/MWEB 支付（本项目当前未实现 H5/MWEB）。

---

## 1. 前置条件与账号准备
- 企业主体的微信支付商户号（MchID）
- 公众号或小程序（用于 JSAPI，需与商户号完成关联）
- 微信商户平台 v3 相关配置
  - 已设置 API v3 密钥（32 位）
  - 已下载商户 API 证书（得到证书序列号 serial_no）
  - 已下载微信支付平台证书（PEM，验签用，注意证书轮换）
- 域名与 HTTPS
  - 正式域名：`mbti.juejing.cc`
  - 预发布域名：`testmbti.juejing.cc`
  - 均需完成备案与证书部署

---

## 2. 微信侧必要配置
1) 在【微信商户平台 → 产品中心 → 开发配置】中：
- 支付结果通知 URL：
  - 预发布：`https://testmbti.juejing.cc/api/wechatpay/notify`
  - 正式：`https://mbti.juejing.cc/api/wechatpay/notify`
- JSAPI 支付授权目录（公众号网页）：
  - 预发布：`https://testmbti.juejing.cc/`
  - 正式：`https://mbti.juejing.cc/`

2) 在【公众平台（公众号）→ 接口权限 → 网页授权】中：
- 网页授权回调域名：
  - 预发布：`testmbti.juejing.cc`
  - 正式：`mbti.juejing.cc`
- 说明：用于 OAuth 获取 `openid`。

3) 在【商户平台 → 账户中心 → API 安全】中：
- 设置并保存 API v3 密钥
- 下载商户 API 证书（记录证书序列号 `serial_no`）
- 下载微信支付平台证书（PEM），用于回调验签

---

## 3. 服务器端环境变量与证书部署
项目通过 `config/payment.wechat` 读取以下环境变量：

```
PAYMENT_ENABLED=true
WECHAT_APP_ID=微信公众号或小程序的AppID
WECHAT_MCH_ID=商户号
WECHAT_API_V3_KEY=32位APIv3密钥
WECHAT_MCH_PRIVATE_KEY_PATH=/etc/mbti/pay/<env>/apiclient_key.pem
WECHAT_MCH_CERT_SERIAL=商户证书序列号serial_no
WECHAT_PLATFORM_CERT_PATH=/etc/mbti/pay/<env>/wechat_platform_cert.pem
WECHAT_NOTIFY_URL=https://<域名>/api/wechatpay/notify
```

- 证书与密钥部署（示例）：
```
# 预发布
/etc/mbti/pay/test/apiclient_key.pem
/etc/mbti/pay/test/wechat_platform_cert.pem

# 正式
/etc/mbti/pay/prod/apiclient_key.pem
/etc/mbti/pay/prod/wechat_platform_cert.pem

sudo chmod 600 /etc/mbti/pay/*/*.pem
sudo chown root:root /etc/mbti/pay/*/*.pem
```

- 注意：本项目后端在创建统一下单时会优先使用 `WECHAT_NOTIFY_URL`；如未设置，将从 `FRONTEND_URL` 推断。正式环境必须显式设置 `WECHAT_NOTIFY_URL`。

---

## 4. 获取 openid（公众号网页 OAuth）
JSAPI 支付必须提供 `payer.openid`。推荐在用户打开页面时完成 OAuth 获取 `openid`，再创建订单。

典型流程：
1) 在微信内打开网页，若无 `openid`，将用户重定向至：
   - `https://open.weixin.qq.com/connect/oauth2/authorize?appid=APPID&redirect_uri=URLEncode(你的回调地址)&response_type=code&scope=snsapi_base&state=STATE#wechat_redirect`
2) 回调地址收到 `code` 后，服务端请求：
   - `https://api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&secret=APPSECRET&code=CODE&grant_type=authorization_code`
3) 响应中包含 `openid`，将其与用户会话绑定，前端创建订单时将 `openid` 一并传给 `/api/payment-orders`。

说明：
- scope 使用 `snsapi_base` 无需弹窗，仅拿 `openid` 即可用于支付。
- 本项目尚未内置 OAuth 路由，请按上述流程在网关或后端补充简单的 OAuth 接口以获取并缓存 `openid`，再调用下单接口。

---

## 5. 创建订单与前端调起支付
- 前端向后端 `POST /api/payment-orders`，关键字段：
  - `user_id`（必填）、`product_type`、`final_amount`（单位：元）、`payment_method='wechat'`、`openid`
- 后端逻辑（已实现）：
  - 写入 `payment_orders`
  - 若检测到 v3 配置完整且提供了 `openid`，调用 JSAPI 统一下单，保存 `prepay_id`
  - 返回 `paymentConfig`（`appId,timeStamp,nonceStr,package,signType='RSA',paySign`）
- 前端收到 `paymentConfig` 后，调用 `WeixinJSBridge.invoke('getBrandWCPayRequest', paymentConfig, cb)` 或使用微信 JS-SDK 进行调起。

---

## 6. 支付回调与报告生成
- 微信服务端回调：`POST /api/wechatpay/notify`
  - 本项目会：
    - 使用平台证书验签（`WECHAT_PLATFORM_CERT_PATH`）
    - 使用 API v3 密钥解密报文
    - 更新 `payment_orders` 支付成功状态与金额
    - 读取 `test_sessions`，生成并 upsert `reports`（`order_id` 唯一）
- 验证：查看 Nginx 访问日志与 Node 日志是否出现 200/`code: SUCCESS`

---

## 7. 金额与单位
- 统一下单时使用分：`amount.total = Math.round(final_amount * 100)`
- 回调解密后金额（分）会折算为元入库，确保与创建单一致

---

## 8. 常见问题排查
- 回调验签失败：
  - 平台证书不匹配或过期；`wechatpay-serial` 与平台证书序列不一致
  - 回调被改写（确保 Nginx 不改写或压缩回调体；本项目已保留 `rawBody`）
- 统一下单报错：
  - 未传 `openid` 或 `openid` 与 `appid` 不匹配
  - `notify_url` 未备案或未HTTPS
- 证书序列号不对：商户证书轮换后需更新 `WECHAT_MCH_CERT_SERIAL`

---

## 9. 预发布与正式环境的区分
- 使用不同的 `.env`、不同的数据库、不同的证书目录
- 不要混用商户号、API v3 密钥和证书
- 不要把预发布 `WECHAT_NOTIFY_URL` 配到正式商户平台（反之亦然）

---

## 10. 最小化上线清单
- [ ] 商户平台：API v3 密钥、平台证书、商户证书序列号就绪
- [ ] 公众号：网页授权域名设置正确
- [ ] 服务端：`.env` 配置与证书文件路径正确，端口联通
- [ ] Nginx：`/api/wechatpay/notify` 直通后端，未改写 body
- [ ] 回调通路验证：下真实 1 元单验证全链路


