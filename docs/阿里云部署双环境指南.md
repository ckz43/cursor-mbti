# 阿里云部署双环境指南（预发布 + 生产）

目标：在同一台阿里云服务器上部署两套完全隔离的实例：
- 预发布环境：`testmbti.juejing.cc`
- 生产环境：`mbti.juejing.cc`

两套实例包括代码、端口、数据库、证书、日志严格隔离，数据不混用。

---

## 1. 服务器准备
- 系统：Ubuntu 22.04 LTS 或等价版本
- 安装基础依赖：
```bash
sudo apt update && sudo apt install -y git nginx mysql-server ufw build-essential curl unzip
# Node.js 20 LTS
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash - && sudo apt install -y nodejs
sudo npm i -g pm2@latest pnpm@9
sudo timedatectl set-timezone Asia/Shanghai
```
- 防火墙/安全组：放行 80/443；Node 仅监听本地端口（例如 3002、3003）

---

## 2. 目录结构与代码
```bash
sudo mkdir -p /srv/mbti-test /srv/mbti-prod /etc/mbti/pay/test /etc/mbti/pay/prod
sudo chown -R $USER:$USER /srv/mbti-test /srv/mbti-prod

# 克隆代码（两份）
cd /srv/mbti-test && git clone <你的Git仓库URL> .
cd /srv/mbti-prod && git clone <你的Git仓库URL> .

# 证书与私钥（分别放置）
# 预发布
/etc/mbti/pay/test/apiclient_key.pem
/etc/mbti/pay/test/wechat_platform_cert.pem
# 生产
/etc/mbti/pay/prod/apiclient_key.pem
/etc/mbti/pay/prod/wechat_platform_cert.pem
sudo chmod 600 /etc/mbti/pay/*/*.pem && sudo chown root:root /etc/mbti/pay/*/*.pem
```

---

## 3. 数据库创建（两套独立）
```sql
-- 预发布
a) CREATE DATABASE mbti_test DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
b) CREATE USER 'mbti_test_u'@'%' IDENTIFIED BY 'StrongPass_Test';
c) GRANT ALL PRIVILEGES ON mbti_test.* TO 'mbti_test_u'@'%';
d) FLUSH PRIVILEGES;

-- 生产
a) CREATE DATABASE mbti_prod DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
b) CREATE USER 'mbti_prod_u'@'%' IDENTIFIED BY 'StrongPass_Prod';
c) GRANT ALL PRIVILEGES ON mbti_prod.* TO 'mbti_prod_u'@'%';
d) FLUSH PRIVILEGES;
```
- 建议仅允许本机访问 DB，或配置白名单

---

## 4. 环境变量文件（.env）
- 预发布 `/srv/mbti-test/.env`
```env
NODE_ENV=production
SERVER_PORT=3002
HOST=127.0.0.1
FRONTEND_URL=https://testmbti.juejing.cc
CORS_ORIGIN=https://testmbti.juejing.cc

DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=mbti_test_u
DB_PASSWORD=StrongPass_Test
DB_NAME=mbti_test

JWT_SECRET=please-change-test

PAYMENT_ENABLED=true
WECHAT_APP_ID=wx_your_test_appid
WECHAT_MCH_ID=your_test_mchid
WECHAT_API_V3_KEY=your_test_v3_key_32chars
WECHAT_MCH_PRIVATE_KEY_PATH=/etc/mbti/pay/test/apiclient_key.pem
WECHAT_MCH_CERT_SERIAL=your_test_cert_serial
WECHAT_PLATFORM_CERT_PATH=/etc/mbti/pay/test/wechat_platform_cert.pem
WECHAT_NOTIFY_URL=https://testmbti.juejing.cc/api/wechatpay/notify

VITE_API_BASE_URL=/api
```

- 生产 `/srv/mbti-prod/.env`
```env
NODE_ENV=production
SERVER_PORT=3003
HOST=127.0.0.1
FRONTEND_URL=https://mbti.juejing.cc
CORS_ORIGIN=https://mbti.juejing.cc

DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=mbti_prod_u
DB_PASSWORD=StrongPass_Prod
DB_NAME=mbti_prod

JWT_SECRET=please-change-prod

PAYMENT_ENABLED=true
WECHAT_APP_ID=wx_your_prod_appid
WECHAT_MCH_ID=your_prod_mchid
WECHAT_API_V3_KEY=your_prod_v3_key_32chars
WECHAT_MCH_PRIVATE_KEY_PATH=/etc/mbti/pay/prod/apiclient_key.pem
WECHAT_MCH_CERT_SERIAL=your_prod_cert_serial
WECHAT_PLATFORM_CERT_PATH=/etc/mbti/pay/prod/wechat_platform_cert.pem
WECHAT_NOTIFY_URL=https://mbti.juejing.cc/api/wechatpay/notify

VITE_API_BASE_URL=/api
```

---

## 5. 安装依赖、初始化数据库与构建
```bash
# 预发布
cd /srv/mbti-test
pnpm install --frozen-lockfile || npm ci
npm run init-db
npm run build

# 生产
cd /srv/mbti-prod
pnpm install --frozen-lockfile || npm ci
npm run init-db
npm run build
```

---

## 6. PM2 启动两套实例
在任意路径新建 `/srv/ecosystem.config.js`：
```js
module.exports = {
  apps: [
    {
      name: 'mbti-test',
      cwd: '/srv/mbti-test',
      script: 'server.js',
      env: { NODE_ENV: 'production' },
      instances: 1,
      exec_mode: 'fork',
      watch: false,
      autorestart: true,
      max_memory_restart: '500M',
    },
    {
      name: 'mbti-prod',
      cwd: '/srv/mbti-prod',
      script: 'server.js',
      env: { NODE_ENV: 'production' },
      instances: 1,
      exec_mode: 'fork',
      watch: false,
      autorestart: true,
      max_memory_restart: '500M',
    }
  ]
}
```

启动并设置开机自启：
```bash
pm2 start /srv/ecosystem.config.js
pm2 status
pm2 save
pm2 startup systemd -u $USER --hp $HOME
```

---

## 7. Nginx 双域名配置
为两套站点分别创建配置：

- `/etc/nginx/sites-available/mbti-test.conf`
```nginx
server {
  listen 80;
  server_name testmbti.juejing.cc;

  root /srv/mbti-test/dist;
  index index.html;

  location / { try_files $uri $uri/ /index.html; }

  location /health {
    proxy_pass http://127.0.0.1:3002/health;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location /api/ {
    proxy_pass http://127.0.0.1:3002;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # WeChat 回调直通
  location = /api/wechatpay/notify {
    proxy_pass http://127.0.0.1:3002/api/wechatpay/notify;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  client_max_body_size 10m;
}
```

- `/etc/nginx/sites-available/mbti-prod.conf`
```nginx
server {
  listen 80;
  server_name mbti.juejing.cc;

  root /srv/mbti-prod/dist;
  index index.html;

  location / { try_files $uri $uri/ /index.html; }

  location /health {
    proxy_pass http://127.0.0.1:3003/health;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location /api/ {
    proxy_pass http://127.0.0.1:3003;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location = /api/wechatpay/notify {
    proxy_pass http://127.0.0.1:3003/api/wechatpay/notify;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  client_max_body_size 10m;
}
```

启用并签发证书：
```bash
sudo ln -s /etc/nginx/sites-available/mbti-test.conf /etc/nginx/sites-enabled/
sudo ln -s /etc/nginx/sites-available/mbti-prod.conf /etc/nginx/sites-enabled/
sudo nginx -t && sudo systemctl reload nginx

sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d testmbti.juejing.cc -d mbti.juejing.cc --redirect --agree-tos -m <你的邮箱>
```

---

## 8. 验证清单
- 访问 `https://testmbti.juejing.cc/health` 与 `https://mbti.juejing.cc/health` 返回 `healthy`
- 前端资源加载正常；两站点互不干扰
- 预发布下单 → 微信支付拉起（在微信内）→ 回调 200 → 数据库 `payment_orders` 状态已更新 → `reports` 有记录
- 首页订单号恢复功能可正确跳转报告页

---

## 9. 运维
- 发布升级（以预发布为例）
```bash
cd /srv/mbti-test
git pull
pnpm install --frozen-lockfile || npm ci
npm run build
pm2 restart mbti-test
```
- 日志查看
```bash
pm2 logs mbti-test
pm2 logs mbti-prod
```
- 建议安装：`pm2 install pm2-logrotate`

---

## 10. 备份与回滚
- 备份数据库
```bash
mysqldump -u mbti_prod_u -p'StrongPass_Prod' mbti_prod > /backup/mbti_prod_$(date +%F).sql
mysqldump -u mbti_test_u -p'StrongPass_Test' mbti_test > /backup/mbti_test_$(date +%F).sql
```
- 回滚代码：保留上次构建的 `dist`，`git checkout <tag/commit>` 后重新 `npm run build` 并 `pm2 restart`

---

## 11. 注意事项
- JSAPI 必须获取 `openid` 才能统一下单
- 预发布与生产的商户号、API v3 密钥、证书严格隔离
- `.env` 的 `FRONTEND_URL` 与 Nginx 域名要一致；`WECHAT_NOTIFY_URL` 必须配置为 HTTPS
- 如遇回调验签失败，检查平台证书是否最新且 `wechatpay-serial` 匹配


