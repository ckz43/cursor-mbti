# 生产部署小白教程（同机双环境：test + prod）

> 目标：照抄命令，即可把本项目部署到一台阿里云服务器上，同时跑起两套环境：
> - 预发布：`testmbti.juejing.cc`
> - 生产：`mbti.juejing.cc`
>
> 架构说明：前端静态资源 + Node API。生产用 Nginx 提供静态资源与反向代理，Node 继续负责 API 与微信支付。

---

## 0. 准备（阿里云 + 域名）
- 域名解析 A 记录到你的公网 IP：
  - `testmbti.juejing.cc` → <你的ECS公网IP>
  - `mbti.juejing.cc` → <你的ECS公网IP>
- 安全组放行 80、443 端口
- 服务器系统：Ubuntu 22.04 LTS（本文以此为例）

---

## 1. 连接服务器
```bash
ssh root@<你的ECS公网IP>
```

---

## 2. 安装基础环境
```bash
apt update && apt install -y git nginx mysql-server ufw build-essential curl unzip
# Node.js 20 LTS
curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && apt install -y nodejs
npm i -g pm2@latest pnpm@9
# 时区（可选）
timedatectl set-timezone Asia/Shanghai
# 防火墙（若使用 UFW）
ufw allow 80/tcp; ufw allow 443/tcp; ufw --force enable || true
```

---

## 3. 目录与代码（两份）
```bash
mkdir -p /srv/mbti-test /srv/mbti-prod /etc/mbti/pay/test /etc/mbti/pay/prod
cd /srv/mbti-test && git clone <你的Git仓库URL> .
cd /srv/mbti-prod && git clone <你的Git仓库URL> .
```

---

## 4. 创建数据库与账号（两套独立库）
说明：只需先建“库+用户”。表结构和初始数据由项目脚本自动创建（下一步会运行 `npm run init-db`）。

```bash
mysql -uroot
```
在 MySQL 提示符内粘贴：
```sql
-- 预发布
a) CREATE DATABASE mbti_test DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
b) CREATE USER 'mbti_test_u'@'localhost' IDENTIFIED BY 'StrongPass_Test';
c) GRANT ALL PRIVILEGES ON mbti_test.* TO 'mbti_test_u'@'localhost';

-- 生产
a) CREATE DATABASE mbti_prod DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
b) CREATE USER 'mbti_prod_u'@'localhost' IDENTIFIED BY 'StrongPass_Prod';
c) GRANT ALL PRIVILEGES ON mbti_prod.* TO 'mbti_prod_u'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

---

## 5. 两套 .env 文件
- 预发布 `/srv/mbti-test/.env`
```env
NODE_ENV=production
SERVER_PORT=3002
HOST=127.0.0.1
FRONTEND_URL=https://testmbti.juejing.cc
CORS_ORIGIN=https://testmbti.juejing.cc

DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=mbti_test_u
DB_PASSWORD=StrongPass_Test
DB_NAME=mbti_test

JWT_SECRET=please-change-test

# 微信支付（可暂留空，接入时再填）
PAYMENT_ENABLED=true
WECHAT_APP_ID=
WECHAT_MCH_ID=
WECHAT_API_V3_KEY=
WECHAT_MCH_PRIVATE_KEY_PATH=/etc/mbti/pay/test/apiclient_key.pem
WECHAT_MCH_CERT_SERIAL=
WECHAT_PLATFORM_CERT_PATH=/etc/mbti/pay/test/wechat_platform_cert.pem
WECHAT_NOTIFY_URL=https://testmbti.juejing.cc/api/wechatpay/notify

VITE_API_BASE_URL=/api
```

- 生产 `/srv/mbti-prod/.env`
```env
NODE_ENV=production
SERVER_PORT=3003
HOST=127.0.0.1
FRONTEND_URL=https://mbti.juejing.cc
CORS_ORIGIN=https://mbti.juejing.cc

DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=mbti_prod_u
DB_PASSWORD=StrongPass_Prod
DB_NAME=mbti_prod

JWT_SECRET=please-change-prod

PAYMENT_ENABLED=true
WECHAT_APP_ID=
WECHAT_MCH_ID=
WECHAT_API_V3_KEY=
WECHAT_MCH_PRIVATE_KEY_PATH=/etc/mbti/pay/prod/apiclient_key.pem
WECHAT_MCH_CERT_SERIAL=
WECHAT_PLATFORM_CERT_PATH=/etc/mbti/pay/prod/wechat_platform_cert.pem
WECHAT_NOTIFY_URL=https://mbti.juejing.cc/api/wechatpay/notify

VITE_API_BASE_URL=/api
```

---

## 6. 安装依赖 + 初始化数据库 + 构建前端
```bash
cd /srv/mbti-test && (pnpm i --frozen-lockfile || npm ci) && npm run init-db && npm run build
cd /srv/mbti-prod && (pnpm i --frozen-lockfile || npm ci) && npm run init-db && npm run build
```

---

## 7. PM2 启动两个 Node 服务
```bash
cat >/srv/ecosystem.config.js <<'EOF'
module.exports = { apps: [
  { name: 'mbti-test', cwd: '/srv/mbti-test', script: 'server.js', env: { NODE_ENV: 'production' } },
  { name: 'mbti-prod', cwd: '/srv/mbti-prod', script: 'server.js', env: { NODE_ENV: 'production' } }
]}
EOF
pm2 start /srv/ecosystem.config.js && pm2 save && pm2 startup systemd -u $(whoami) --hp $HOME
pm2 status
```

---

## 8. Nginx 反向代理 + 静态站点
```bash
# 预发布
envsubst >/etc/nginx/sites-available/mbti-test.conf <<'EOF'
server {
  listen 80;
  server_name testmbti.juejing.cc;
  root /srv/mbti-test/dist;
  index index.html;
  location / { try_files $uri $uri/ /index.html; }
  location /health { proxy_pass http://127.0.0.1:3002/health; }
  location /api/ {
    proxy_pass http://127.0.0.1:3002;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
  location = /api/wechatpay/notify {
    proxy_pass http://127.0.0.1:3002/api/wechatpay/notify;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}
EOF

# 生产
envsubst >/etc/nginx/sites-available/mbti-prod.conf <<'EOF'
server {
  listen 80;
  server_name mbti.juejing.cc;
  root /srv/mbti-prod/dist;
  index index.html;
  location / { try_files $uri $uri/ /index.html; }
  location /health { proxy_pass http://127.0.0.1:3003/health; }
  location /api/ {
    proxy_pass http://127.0.0.1:3003;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
  location = /api/wechatpay/notify {
    proxy_pass http://127.0.0.1:3003/api/wechatpay/notify;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}
EOF

rm -f /etc/nginx/sites-enabled/default
ln -sf /etc/nginx/sites-available/mbti-test.conf /etc/nginx/sites-enabled/
ln -sf /etc/nginx/sites-available/mbti-prod.conf /etc/nginx/sites-enabled/
nginx -t && systemctl reload nginx
```

---

## 9. HTTPS 证书（自动续期）
```bash
apt install -y certbot python3-certbot-nginx
certbot --non-interactive --nginx -d testmbti.juejing.cc -d mbti.juejing.cc --redirect --agree-tos -m <你的邮箱>
```

---

## 10. 验证
```bash
curl -sS https://testmbti.juejing.cc/health
curl -sS https://mbti.juejing.cc/health
pm2 logs mbti-test --lines 200 | tail -n +1
pm2 logs mbti-prod --lines 200 | tail -n +1
```

---

## 11. 微信支付接入（稍后再做亦可）
- `.env` 填写微信参数并把证书放到：
  - 预发布 `/etc/mbti/pay/test/`
  - 生产 `/etc/mbti/pay/prod/`
- 前端携带 `openid` 调 `POST /api/payment-orders`，回调地址 `/api/wechatpay/notify`
- 详见：`docs/微信支付接入说明.md`

---

## 12. 常见问答
- 本地 Node，生产 Nginx，会冲突吗？
  - 不会。生产架构：用户 → Nginx →(静态/反代)→ Node API。Node 跑 3002/3003，Nginx 负责转发与 HTTPS。
- 为什么只建库和用户，不建表？
  - `npm run init-db` 已自动建表并灌入初始数据。
- 如何上线新版本？
  - 预发布：`cd /srv/mbti-test && git pull && pnpm i || npm ci && npm run build && pm2 restart mbti-test`
  - 生产：`cd /srv/mbti-prod && git pull && pnpm i || npm ci && npm run build && pm2 restart mbti-prod`

---

## 13. 一键脚本
服务器上直接执行：
```bash
bash /srv/mbti/scripts/one-click-deploy.sh
```
如需自定义域名/仓库/邮箱/数据库密码，请先编辑脚本顶部变量（见 `scripts/one-click-deploy.sh`）。
